{% extends 'base/base.html' %}
{% block title %}
Checkout
{% endblock title %}

{% block style %}
<!-- Add any additional CSS styles if needed -->
{% endblock style %}

{% block content %}
<!-- Breadcrumb Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-12">
            <nav class="breadcrumb bg-light mb-30">
                <a class="breadcrumb-item text-dark" href="">Home</a>
                <a class="breadcrumb-item text-dark" href="">Shopping Cart</a>
                <span class="breadcrumb-item active">Checkout</span>
            </nav>
        </div>
    </div>
</div>
<!-- Breadcrumb End -->

<!-- Checkout Start -->
<div class="container-fluid">
    <div class="row px-xl-5">
        <div class="col-lg-8">
            <h5 class="section-title position-relative text-uppercase mb-3"><span class="bg-secondary pr-3">Billing Address</span></h5>
            <form id="checkout-form" method="post" action="{% url 'checkout' %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="address">Select Address</label>
                    <select id="address" name="address_id" class="form-control">
                        {% for address in addresses %}
                        <option value="{{ address.id }}"><span>{{ address.address_line1 }},{{ address.address_line2 }}, {{ address.city }}, {{ address.state }} - {{ address.postal_code }}</span></option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Payment Method</label>
                    <div class="form-check">
                        <input type="radio" id="cod" name="payment_method" value="COD" class="form-check-input" checked>
                        <label class="form-check-label" for="cod">Cash on Delivery</label>
                    </div>
                    <div class="form-check">
                        <input type="radio" id="razorpay" name="payment_method" value="RAZORPAY" class="form-check-input" >
                        <label class="form-check-label" for="razorpay">online payment</label>
                    </div>
                </div>

                <button type="submit" class="btn btn-block btn-primary font-weight-bold my-3 py-3" id="checkout-button">Proceed To Checkout</button>
            </form>
        </div>
    </div>
</div>
<!-- Checkout End -->

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
    document.getElementById('checkout-form').addEventListener('submit', function(event) {
        event.preventDefault();
        const form = event.target;
        const paymentMethod = form.querySelector('input[name="payment_method"]:checked').value;

        if (paymentMethod === 'RAZORPAY') {
            fetch('/checkout/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    address_id: form.querySelector('select[name="address_id"]').value,
                    payment_method: 'RAZORPAY'
                })
            })
            .then(response => response.json())
            .then(data => {
                const options = {
                    key: 'YOUR_KEY_ID',
                    amount: data.amount * 100, // Amount in paise
                    currency: 'INR',
                    name: 'Your Shop',
                    order_id: data.razorpay_order_id,
                    handler: function (response) {
                        // Handle successful payment here
                        fetch('/payment/webhook/', {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': '{{ csrf_token }}',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                razorpay_payment_id: response.razorpay_payment_id,
                                razorpay_order_id: response.razorpay_order_id,
                                razorpay_signature: response.razorpay_signature
                            })
                        }).then(res => res.json()).then(result => {
                            if (result.status === 'success') {
                            } else {
                                alert('Payment failed');
                            }
                        });
                    },
                    prefill: {
                        name: '',
                        email: '',
                        contact: ''
                    },
                    theme: {
                        color: '#3399cc'
                    }
                };
                const paymentObject = new Razorpay(options);
                paymentObject.open();
            });
        } else {
            form.submit(); // Submit form for Cash on Delivery
        }
    });
</script>
{% endblock content %}
